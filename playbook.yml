---
- hosts: all
  gather_facts: False

  vars:
    mysql_root_username: root
    mysql_root_password: p24HOXBdY9qfZg
  
  tasks:
    - name: install python 2
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      
    - name: Update apt cache if needed.
      apt: update_cache=yes cache_valid_time=86400

      # PHP 7 stuff
    - name: PHP | Add php-7.0 PPA
      apt_repository: repo='ppa:ondrej/php'
                  state=present
                  update_cache=yes
      sudo: true

    - name: PHP | install php packages
      apt: pkg={{ item }} state=installed
      with_items:
        - php7.0-fpm
        - php7.0-cli
        - php7.0-common
        - php7.0-curl
        - php7.0-json
        - php7.0-gd
        - php7.0-mcrypt
        - php7.0-odbc
        - php7.0-mbstring
        - php7.0-mysql
        - php7.0-xmlrpc
        - php7.0-opcache
        - php7.0-intl
        - php7.0-bz2
        - php7.0-xml
      sudo: true

    - name: MySQL | install MySQL
      apt: pkg={{ item }} state=installed
      with_items:
        - mysql-common
        - mysql-server
      sudo: true

    - name: Get MySQL version.
      command: 'mysql --version'
      register: mysql_cli_version
      changed_when: false

    - name: Disallow root login remotely
      command: 'mysql -NBe "{{ item }}"'
      with_items:
        - DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1')
      changed_when: false

    - name: Get list of hosts for the root user.
      command: mysql -NBe 'SELECT Host FROM mysql.user WHERE User = "root" ORDER BY (Host="localhost") ASC'
      register: mysql_root_hosts
      changed_when: false
      always_run: true

    - name: Update MySQL root password for localhost root account (5.7.x).
      shell: >
        mysql -u root -NBe
        'ALTER USER "{{ mysql_root_username }}"@"{{ item }}" IDENTIFIED WITH mysql_native_password BY "{{ mysql_root_password }}";'
      with_items: "{{ mysql_root_hosts.stdout_lines|default([]) }}"

        
    # Has to be after the root password assignment, for idempotency.
    - name: Copy .my.cnf file with root password credentials.
      template:
        src: "./templates/user-my.cnf.j2"
        dest: "/root/.my.cnf"
        owner: root
        group: root
        mode: 0600
